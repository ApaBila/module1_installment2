---
title: "STAT 628 Credit Risk Project: Installment 2 (technical)"
author: "Bohyoon Lee and Salsabila Mahdi"
date: last-modified
format: pdf
geometry:
  - margin=1in
---

```{r}
#| label: setup
#| echo: false
#| warning: false

rm(list = ls())

library(dplyr)
library(ModelMetrics)
library(MASS)
library(car)
library(caret)
library(glmnet)
library(ggplot2)
```



```{r load_clean}
installment2_id01 <- read.csv("installment2_id01.csv")
str(installment2_id01)
summary(installment2_id01)

# make NAICS, WomanOwned, FICO categorical variables

installment2_id01 = installment2_id01 %>%
  mutate(NAICS = as.factor(substr(NAICS, 1, 6)), # TODO: talk about simplifying
         WomanOwned = as.factor(WomanOwned),
         FICO = case_when(
           (300 <= FICO)&(FICO <= 579) ~ "Poor",
           (580 <= FICO)&(FICO <= 669) ~ "Fair",
           (670 <= FICO)&(FICO <= 739) ~ "Good",
           (740 <= FICO)&(FICO <= 799) ~ "Very Good",
           (800 <= FICO)&(FICO <= 850) ~ "Excellent",
         ))

```


```{r remove_outliers}
fullmodel <- lm(PRSM ~., data = installment2_id01)
plot(fullmodel,1)
installment2_id01$residual=residuals(fullmodel)

# remove 11 outliers observed in the plot (abs(residual)>=1)
installment2_id01_clean = installment2_id01 %>% 
  filter(abs(residual)<=1) %>% 
  dplyr::select(-residual) # clean data (use this!!)

model_clean = lm(PRSM ~. , data = installment2_id01_clean) 
plot(model_clean,1) # these look much better! but perhaps discuss different outlier removal techniques

summary(model_clean)

```

```{r transform}
# Months seems to need transformation
crPlots(model_clean) 

# this matches hint 1 of the assignment
crPlots(lm(PRSM ~ Months, data = installment2_id01_clean))

# Transform Months Model
boxTidwell(PRSM ~ TotalAmtOwed + Volume + Stress + Num_Delinquent + Num_CreditLines + Months,
          data = installment2_id01_clean)

transformed_model <- lm(PRSM ~ . - Months + I(Months^(-1.19487)),
                       data = installment2_id01_clean)

summary(transformed_model)
rmse(transformed_model$fitted.values, installment2_id01_clean$PRSM) # 0.1018195
```


```{r rm_var}
# Step Model
step_model <- step(transformed_model, trace = 0, direction = "both")
summary(step_model)
# Step Model removed NAICS, Num_Delinquent, and Num_CreditLines
rmse(step_model$fitted.values, installment2_id01_clean$PRSM) # RMSE = 0.1025071


# 10-fold Cross-Validation
cv10 = trainControl(method = "cv", number = 10)
model_cv = train(PRSM ~ FICO + TotalAmtOwed + Volume + Stress + WomanOwned + 
      CorpStructure + I(Months^(-1.19487)), data = installment2_id01_clean, 
      method ="lm", trControl =cv10) # RMSE = 0.1031503
summary(model_cv)

# Volume is not significant (remove later)
```

```{r interaction_lasso}

# Find interactions using LASSO
installment2_id01_clean$Months_transformed =
  (installment2_id01_clean$Months)^(-1.19487)
x <- model.matrix(PRSM ~ .^2, 
                  data = installment2_id01_clean[,c("PRSM", "FICO",
                                                    "TotalAmtOwed","Stress",
                                                    "WomanOwned", "CorpStructure",
                                                    "Months_transformed")])[, -1]
y <- installment2_id01_clean$PRSM
cv_lasso_interactions <- cv.glmnet(x, y, alpha = 1, nfolds = 10)

best_lambda <- cv_lasso_interactions$lambda.min
lasso_coeffs <- coef(cv_lasso_interactions, s = best_lambda)

threshold <- 0.001
significant_terms <- lasso_coeffs[abs(lasso_coeffs[,1]) > threshold, , drop = FALSE]
print(significant_terms)

# potential interactions: FICO:Stress, FICO:WomanOwned, FICO:CorpStructure, FICO:Months_transformed, Stress:WomanOwned, Stress:CorpStructure, WomanOwned:CorpStructure, WomanOwned:Months_transformed, CorpStructure:Months_transformed

interact_model = lm(PRSM ~. + FICO:Stress + FICO:WomanOwned + FICO:CorpStructure 
                    + FICO:Months_transformed + Stress:WomanOwned 
                    + Stress:CorpStructure + WomanOwned:CorpStructure 
                    + WomanOwned:Months_transformed + CorpStructure:Months_transformed
                      , data = installment2_id01_clean[,c("PRSM", "FICO",
                                                    "TotalAmtOwed","Stress",
                                                    "WomanOwned", "CorpStructure",
                                                    "Months_transformed")])
summary(interact_model)
step_interact_model = step(interact_model, trace = 0, direction = "both")
summary(step_interact_model) # printed R summary of the fitted model
# Step Model removed NAICS, Num_Delinquent, and Num_CreditLines
rmse(step_interact_model$fitted.values, installment2_id01_clean$PRSM) # RMSE = 0.09830548


# TODO: look over hints..., multiple regression assumptions, interpretations of the parameters, explanation for how we selected the characteristics of the baseline borrower
# current findings:
# Stress:WomanOwned1, and LLC but smaller => pos. 
# WomanOwned1:CorpStructurePartner => pos.
# FICOFair&Poor:WomanOwned1 => neg!
# FICOFair&Good:Monts => neg. Hint diminished effect again
# CorpStructureSole:p_delinquent => neg. p-delinquent harder on Sole owner


ggplot(data = installment2_id01_clean, aes(x = WomanOwned)) +
  geom_bar() +
  facet_wrap(~ FICO)

```



