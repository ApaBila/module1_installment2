---
title: "STAT 628 Credit Risk Project: Installment 2 (executive)"
author: "Bohyoon Lee and Salsabila Mahdi"
date: last-modified
format: pdf
geometry:
  - margin=1in
---

```{r}
#| label: setup
#| echo: false
#| warning: false

rm(list = ls())

library(dplyr)
library(ModelMetrics)
library(car)
library(glmnet)
library(ggplot2)
library(knitr)
library(gtsummary)
```

```{r load_clean, echo=FALSE}
installment2_id01 <- read.csv("installment2_id01.csv")

# make NAICS, WomanOwned, FICO categorical variables

installment2_id01 = installment2_id01 %>%
  mutate(NAICS = as.factor(substr(NAICS, 1, 2)),
         WomanOwned = as.factor(WomanOwned),
#         Num_Delinquent = as.factor(Num_Delinquent),
#         Num_CreditLines = as.factor(Num_CreditLines),
         FICO = case_when(
           (300 <= FICO)&(FICO <= 579) ~ "Poor",
           (580 <= FICO)&(FICO <= 669) ~ "Fair",
           (670 <= FICO)&(FICO <= 739) ~ "Good",
           (740 <= FICO)&(FICO <= 799) ~ "Very Good",
           (800 <= FICO)&(FICO <= 850) ~ "Excellent",
         ))

```

```{r remove_outliers, warning=FALSE, echo=FALSE}
installment2_id01_clean <- subset(installment2_id01, PRSM > 0 & PRSM < 2)
```

```{r transform, warning=FALSE, echo=FALSE}

# Transformations from boxTidwell
boxTidwell_results <- boxTidwell(PRSM ~ TotalAmtOwed + Volume + Stress + Num_Delinquent + Num_CreditLines + Months,
          data = installment2_id01_clean)

lambda_months <- boxTidwell_results$result[c("Months"),c("MLE of lambda")]
lambda_num_delinquent <- boxTidwell_results$result[c("Num_Delinquent"),c("MLE of lambda")]

transformed_model <- lm(PRSM ~ . - Months + I(Months^(lambda_months)) - Num_Delinquent + I(Num_Delinquent^(lambda_num_delinquent)),
                       data = installment2_id01_clean)
```

```{r rm_var, warning=FALSE, echo=FALSE}
# Step Model
step_model <- step(transformed_model, trace = 0, direction = "both")
```

```{r interaction_lasso, echo=FALSE}
# Find interactions using LASSO
installment2_id01_clean$Months_transformed =
  (installment2_id01_clean$Months)^(lambda_months)
x <- model.matrix(PRSM ~ .^2, 
                  data = installment2_id01_clean[,c("PRSM", "FICO",
                                                    "TotalAmtOwed","Stress",
                                                    "WomanOwned", "CorpStructure",
                                                    "Months_transformed", "NAICS")])[, -1]
y <- installment2_id01_clean$PRSM
cv_lasso_interactions <- cv.glmnet(x, y, alpha = 1, nfolds = 10)

best_lambda <- cv_lasso_interactions$lambda.min
lasso_coeffs <- coef(cv_lasso_interactions, s = best_lambda)

threshold <- 0.001
significant_terms <- lasso_coeffs[abs(lasso_coeffs[,1]) > threshold, , drop = FALSE]

# potential interactions: FICO:Stress, FICO:WomanOwned, FICO:CorpStructure, FICO:Months_transformed, Stress:WomanOwned, Stress:CorpStructure, WomanOwned:CorpStructure, WomanOwned:Months_transformed, CorpStructure:Months_transformed, FICO:NAICS, WomanOwned:NAICS, CorpStructure:NAICS, Months_transformed:NAICS, Stress:NAICS

interact_model = lm(PRSM ~. + FICO:Stress + FICO:WomanOwned + FICO:CorpStructure 
                    + FICO:Months_transformed + Stress:WomanOwned 
                    + Stress:CorpStructure + WomanOwned:CorpStructure 
                    + WomanOwned:Months_transformed + CorpStructure:Months_transformed
                    + FICO:NAICS + WomanOwned:NAICS + CorpStructure:NAICS 
                    + Months_transformed:NAICS + Stress:NAICS
                      , data = installment2_id01_clean[,c("PRSM", "FICO",
                                                    "TotalAmtOwed","Stress",
                                                    "WomanOwned", "CorpStructure",
                                                    "Months_transformed", "NAICS")])
step_interact_model = step(interact_model, trace = 0, direction = "both")

# NAICS is not statistically significant; remove NAICS
interact_model_final = lm(PRSM ~. + FICO:Stress + FICO:WomanOwned + FICO:CorpStructure 
                    + FICO:Months_transformed + Stress:WomanOwned 
                    + Stress:CorpStructure + WomanOwned:CorpStructure 
                    + WomanOwned:Months_transformed + CorpStructure:Months_transformed
                      , data = installment2_id01_clean[,c("PRSM", "FICO",
                                                    "TotalAmtOwed","Stress",
                                                    "WomanOwned", "CorpStructure",
                                                    "Months_transformed")])
step_interact_final = step(interact_model_final, trace = 0, direction = "both")

```

```{r baseline, echo=FALSE}
newdata<-installment2_id01_clean[1,]

newdata[,c("FICO")] <- "Good"
newdata[,c("TotalAmtOwed")] <- median(installment2_id01_clean$TotalAmtOwed)
newdata[,c("Stress")] <- median(installment2_id01_clean$Stress)
newdata[,c("WomanOwned")] <- "0"
newdata[,c("CorpStructure")] <- "LLC"
newdata[,c("Months_transformed")] <- median(installment2_id01_clean$Months_transformed)

predicted_PRSM <- as.data.frame(round(predict(step_interact_final, 
        newdata=newdata), 8))
```

Our analysis of credit risk, measured here by the PRSM score, reveals that a borrower's risk profile is not determined by a single characteristic but a complex interplay of characteristics. The key characteristics are the business's FICO score, its financial stress level, ownership structure (e.g., woman-owned, corporate structure), and months of operation.

-   Compared to borrowers with the Excellent FICO (credit) score, all other borrowers (from the remaining FICO categories) have lower PRSM.
-   Total amount owed to the credit union has no practical effect on PRSM.
-   Stress has a strong positive effect on PRSM.
-   Women-owned businesses have a higher PRSM than otherwise businesses.
-   Compared to corporations, partnership and limited liability corporation (LLC) business structures have higher PRSM. On the other hand, sole proprietorship does not have discernible effect on PRSM.
-   The number of months for which the business has been open has an negative impact on PRSM.
-   The negative effects of lower FICO categories are decreased if the business is women-owned.
-   TODO: FICO:Months
-   TODO: Stress:WomanOwned1 Women-owned businesses tend to have more monthly garnishment to the expected volume of credit card transactions than others.
-   The LLC corporate structure does not perform well if the business is owned by women.
-   TODO: CorpStructure:Month_transformed

The baseline borrower has a Good FICO score, \$`r format(median(installment2_id01_clean$TotalAmtOwed),big.mark = ",")` of total amount owed, and `r round(median(installment2_id01_clean$Stress),2)` of stress, is not a woman, has a business structured as a LLC, and has opened the business for `r median(installment2_id01_clean$Months)` months. The predicted PRSM is `r round(predicted_PRSM,3)`

TODO: final summary

| Contributions | Bohyoon Lee | Salsabila Mahdi |
|---------------|-------------|-----------------|
|               |             |                 |
|               |             |                 |
|               |             |                 |
