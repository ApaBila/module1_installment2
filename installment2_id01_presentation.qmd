---
title: "STAT 628 Credit Risk Project: Installment 2 (presentation)"
author: "Bohyoon Lee and Salsabila Mahdi"
format: 
  beamer
---

```{r}
#| label: setup
#| echo: false
#| warning: false 

rm(list = ls())

library(dplyr)
library(ModelMetrics)
library(MASS)
library(car)
library(caret)
library(glmnet)
library(ggplot2)
library(knitr)
library(gtsummary)
library(patchwork)
library(kableExtra)
```

## Content

-   Data Preprocessing and Cleaning

-   Model Development and Selection

    1.  Linearity and predictor transformation
    2.  Variable and interaction selection

-   Result and Interpretation
-   Outlines Avenues for Future Development or Improvement

## Data Preprocessing

-   We load and preprocess the data to ensure the nonnumerical variables aren't considered numerical by R (FICO, NAICS, WomanOwned).

```{r load_clean}
installment2_id01 <- read.csv("installment2_id01.csv")

# make NAICS, WomanOwned, FICO categorical variables

installment2_id01 = installment2_id01 %>%
  mutate(NAICS = as.factor(substr(NAICS, 1, 2)),
         WomanOwned = as.factor(WomanOwned),
#         Num_Delinquent = as.factor(Num_Delinquent),
#         Num_CreditLines = as.factor(Num_CreditLines),
         FICO = case_when(
           (300 <= FICO)&(FICO <= 579) ~ "Poor",
           (580 <= FICO)&(FICO <= 669) ~ "Fair",
           (670 <= FICO)&(FICO <= 739) ~ "Good",
           (740 <= FICO)&(FICO <= 799) ~ "Very Good",
           (800 <= FICO)&(FICO <= 850) ~ "Excellent",
         ))

theme_gtsummary_compact()
installment2_id01 %>% 
  select(FICO, NAICS, WomanOwned) %>% 
  tbl_summary(
    statistic = list(
      all_continuous() ~ c(
        "{median} ({p25}, {p75})",
        "{min}, {max}"
      )
    ),
    type = all_continuous() ~ "continuous2"
  ) %>% 
  modify_header(all_stat_cols() ~ "**N = {N}**") %>% 
  modify_footnote(everything() ~ NA_character_)
# TODO: meaningful units?


```

## Data Preprocessing

-   We then notice a few points have PRSM values that are out of distribution (less than 0 or greater than 2) and remove them.

```{r with_outliers, warning=FALSE}

installment2_id01 %>% 
  summarise(`min PRSM` = min(PRSM),
            `median PRSM` = median(PRSM),
            `mean PRSM` = mean(PRSM),
            `max PRSM` = max(PRSM)) %>% 
  kable(digits = 2, caption = "PRSM with outliers")
```
-   The summary of the PRSM after removing the outliers.

```{r remove_outliers,warning=FALSE}
installment2_id01_clean <- subset(installment2_id01, PRSM > 0 & PRSM < 2)
installment2_id01_summary = installment2_id01_clean %>% 
  summarise(`min PRSM` = min(PRSM),
            `median PRSM` = median(PRSM),
            `mean PRSM` = mean(PRSM),
            `max PRSM` = max(PRSM))

kable(installment2_id01_summary, digits = 2, caption = "PRSM after removing outliers")
```



## Model Development and Selection

### 1. Linearity and predictor transformation

-   Months shows non-linearity

```{r linearity, warning=FALSE}
crPlots(lm(PRSM ~ Months, data = installment2_id01_clean))
```

## Model Development and Selection

### 1. Linearity and predictor transformation

```{r transform1, warning=FALSE}
# Transformations from boxTidwell
boxTidwell_results <- boxTidwell(PRSM ~ TotalAmtOwed +
                                   Volume + Stress + Num_Delinquent +
                                   Num_CreditLines + Months,
          data = installment2_id01_clean)

lambda_months <- boxTidwell_results$result[c("Months"),c("MLE of lambda")]
lambda_num_delinquent <- boxTidwell_results$result[c("Num_Delinquent"),c("MLE of lambda")]
```

-   We transform Months and Num_Delinquent to approximately its inverse (to be precise, Box-Tidwell suggests `r round(lambda_months, 2)` for Months, `r round(lambda_num_delinquent, 2)` for Num_Delinquent).

```{r transform_table, warning=FALSE}
boxTidwell_results$result[,c("MLE of lambda","Pr(>|t|)" )] %>% 
  as.data.frame %>% 
  mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05", 
                             sprintf("%.2f", `Pr(>|t|)`))) %>%
  kable(digits = 2)

```

## Model Development and Selection

### 1. Linearity and predictor transformation

-   The Month predictor transformed is statistically significant but Num_Delinquent is not. Therefore, we remove Num_Delinquent for predictor selection

```{r transform2, warning=FALSE}
transformed_model <- lm(PRSM ~ . - Months + I(Months^(lambda_months)) - Num_Delinquent + I(Num_Delinquent^(lambda_num_delinquent)),
                       data = installment2_id01_clean)

summary(transformed_model)$coefficients[,"Pr(>|t|)", drop = FALSE] %>% 
  as.data.frame %>% 
  slice((n() - 1):n()) %>% 
  mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05", 
                             sprintf("%.2f", `Pr(>|t|)`))) %>%
  kable(digits = 2)
```

## Model Development and Selection

### 1. Linearity and predictor transformation

-   Transformed Months

```{r linear_month, warning=FALSE}
crPlots(lm(PRSM ~ I(Months^(lambda_months)), data = installment2_id01_clean))
```

## Model Development and Selection

### 2. Variable and interaction selection

-   We aim to create a parsimonious model that explains the most variance. We do this in a multi-stage selection process.

-   First, we use bidirectional stepwise on the model containing all main effects (with Months transformed). It identifies Num_Delinquent, and Num_CreditLines as statistically non-significant predictors and removes them. We also remove Volume as it is statistically non-significant and its effect is most likely covered by Stress.

## Model Development and Selection

### 2. Variable and interaction selection

```{r rm_var, warning=FALSE}
# Step Model
step_model <- step(transformed_model, trace = 0, direction = "both")
summary(step_model)$coefficients[,c("Estimate","Pr(>|t|)")] %>% 
  as.data.frame %>% 
  slice(2:n()) %>% 
  mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05", 
                             sprintf("%.2f", `Pr(>|t|)`))) %>%
  kable(digits = 2)
```

## Model Development and Selection

### 2. Variable and interaction selection

-   Secondly, we search for statistically significant two-way interactions with LASSO, that affect PRSM meaningfully. We add quite a few interactions between FICO, Stress, WomanOwned and CorpStructure with other predictors to the model.

-   FICO:Stress, FICO:WomanOwned, FICO:CorpStructure, FICO:Months_transformed, Stress:WomanOwned, Stress:CorpStructure, WomanOwned:CorpStructure, WomanOwned:Months_transformed, CorpStructure:Months_transformed, FICO:NAICS, WomanOwned:NAICS, CorpStructure:NAICS, Months_transformed:NAICS, Stress:NAICS are selected as potential interactions.

## Final Model Selection

-   Finally, we again use bidirectional stepwise on the model containing all main effects and potential interactions to finalize the practical predictors including interactions.

## Final Model Selection
\tiny
```{r interaction_lasso}
# Find interactions using LASSO
installment2_id01_clean$Months_transformed =
  (installment2_id01_clean$Months)^(lambda_months)
x <- model.matrix(PRSM ~ .^2, 
                  data = installment2_id01_clean[,c("PRSM", "FICO",
                                                    "TotalAmtOwed","Stress",
                                                    "WomanOwned", "CorpStructure",
                                                    "Months_transformed", "NAICS")])[, -1]
y <- installment2_id01_clean$PRSM
cv_lasso_interactions <- cv.glmnet(x, y, alpha = 1, nfolds = 10)

best_lambda <- cv_lasso_interactions$lambda.min
lasso_coeffs <- coef(cv_lasso_interactions, s = best_lambda)

threshold <- 0.001
significant_terms <- lasso_coeffs[abs(lasso_coeffs[,1]) > threshold, , drop = FALSE]

# potential interactions: FICO:Stress, FICO:WomanOwned, FICO:CorpStructure, FICO:Months_transformed, Stress:WomanOwned, Stress:CorpStructure, WomanOwned:CorpStructure, WomanOwned:Months_transformed, CorpStructure:Months_transformed, FICO:NAICS, WomanOwned:NAICS, CorpStructure:NAICS, Months_transformed:NAICS, Stress:NAICS

interact_model = lm(PRSM ~. + FICO:Stress + FICO:WomanOwned + FICO:CorpStructure 
                    + FICO:Months_transformed + Stress:WomanOwned 
                    + Stress:CorpStructure + WomanOwned:CorpStructure 
                    + WomanOwned:Months_transformed + CorpStructure:Months_transformed
                    + FICO:NAICS + WomanOwned:NAICS + CorpStructure:NAICS 
                    + Months_transformed:NAICS + Stress:NAICS
                      , data = installment2_id01_clean[,c("PRSM", "FICO",
                                                    "TotalAmtOwed","Stress",
                                                    "WomanOwned", "CorpStructure",
                                                    "Months_transformed", "NAICS")])
step_interact_model = step(interact_model, trace = 0, direction = "both")
```

```{r summary, warning=FALSE}
# printed R summary of the fitted model
summary(step_interact_model)$coefficients[,c("Estimate","Pr(>|t|)")] %>% 
  as.data.frame %>% 
  mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05", 
                             sprintf("%.3f", `Pr(>|t|)`))) %>%
  kable(digits = 3)
```


```{r final_model_checks}
# TODO: look over hints..., multiple regression assumptions, interpretations of the parameters, explanation for how we selected the characteristics of the baseline borrower

# CHECK ASSUMPTIONS FOR FINAL MODEL
# plot(step_interact_model, 2)
# plot(step_interact_model, 1)
# vif(step_interact_model) # <5, still ok for multicol

# kable(summary(step_interact_model)$coefficients[,c("Estimate","Pr(>|t|)")], digits = 3)
# ggplot(data = installment2_id01_clean, aes(x = WomanOwned)) +
#   geom_bar() +
#   facet_wrap(~ FICO)

# summary(installment2_id01$Stress)
```

## Result and Interpretation
\small
-   Compared to borrowers with the Excellent FICO (credit) score, all other borrowers (from the remaining FICO categories) have lower PRSM.
-   Total amount owed to the credit union has no practical effect on PRSM.
-   Stress has a strong positive effect on PRSM.
-   Women-owned businesses have a higher PRSM than otherwise businesses.
-   Compared to corporations, partnership and limited liability corporation (LLC) business structures have higher PRSM. On the other hand, sole proprietorship does not have discernible effect on PRSM.
-   The number of months for which the business has been open has an negative impact on PRSM.
-   The negative effects of lower FICO categories are decreased if the business is women-owned.
-   Women-owned businesses tend to have more stress than others.
-   The LLC corporate structure does not perform well if the business is owned by women.

## Outlines Avenues for Future Development or Improvement