+ Stress:CorpStructure + WomanOwned:CorpStructure
+ WomanOwned:Months_transformed + CorpStructure:Months_transformed
+ FICO:NAICS + WomanOwned:NAICS + CorpStructure:NAICS
+ Months_transformed:NAICS + Stress:NAICS
, data = installment2_id01_clean[,c("PRSM", "FICO",
"TotalAmtOwed","Stress",
"WomanOwned", "CorpStructure",
"Months_transformed", "NAICS")])
step_interact_model = step(interact_model, trace = 0, direction = "both")
# printed R summary of the fitted model
summary(step_interact_model)$coefficients[,c("Estimate","Pr(>|t|)")] %>%
as.data.frame %>%
mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05",
sprintf("%.3f", `Pr(>|t|)`))) %>%
kable(digits = 3)
summary(step_interact_model)$coefficients[,c("Estimate","Pr(>|t|)")] %>%
as.data.frame %>%
mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05",
sprintf("%.3f", `Pr(>|t|)`))) %>%
kable(digits = 3)
#| label: setup
#| echo: false
#| warning: false
rm(list = ls())
library(dplyr)
library(ModelMetrics)
library(MASS)
library(car)
library(caret)
library(glmnet)
library(ggplot2)
library(knitr)
library(gtsummary)
library(patchwork)
tidy(step_interact_model)
step_interact_model
step_interact_model <- step(interact_model, trace = 0, direction = "both")
#| label: setup
#| echo: false
#| warning: false
rm(list = ls())
library(dplyr)
library(ModelMetrics)
library(MASS)
library(car)
library(caret)
library(glmnet)
library(ggplot2)
library(knitr)
library(gtsummary)
library(patchwork)
installment2_id01 <- read.csv("installment2_id01.csv")
# make NAICS, WomanOwned, FICO categorical variables
installment2_id01 = installment2_id01 %>%
mutate(NAICS = as.factor(substr(NAICS, 1, 2)),
WomanOwned = as.factor(WomanOwned),
#         Num_Delinquent = as.factor(Num_Delinquent),
#         Num_CreditLines = as.factor(Num_CreditLines),
FICO = case_when(
(300 <= FICO)&(FICO <= 579) ~ "Poor",
(580 <= FICO)&(FICO <= 669) ~ "Fair",
(670 <= FICO)&(FICO <= 739) ~ "Good",
(740 <= FICO)&(FICO <= 799) ~ "Very Good",
(800 <= FICO)&(FICO <= 850) ~ "Excellent",
))
theme_gtsummary_compact()
installment2_id01 %>%
select(FICO, NAICS, WomanOwned) %>%
tbl_summary(
statistic = list(
all_continuous() ~ c(
"{median} ({p25}, {p75})",
"{min}, {max}"
)
),
type = all_continuous() ~ "continuous2"
) %>%
modify_header(all_stat_cols() ~ "**N = {N}**") %>%
modify_footnote(everything() ~ NA_character_)
# TODO: meaningful units?
installment2_id01 %>%
summarise(`min PRSM` = min(PRSM),
`median PRSM` = median(PRSM),
`mean PRSM` = mean(PRSM),
`max PRSM` = max(PRSM)) %>%
kable(digits = 2, caption = "PRSM with outliers")
installment2_id01_clean <- subset(installment2_id01, PRSM > 0 & PRSM < 2)
installment2_id01_summary = installment2_id01_clean %>%
summarise(`min PRSM` = min(PRSM),
`median PRSM` = median(PRSM),
`mean PRSM` = mean(PRSM),
`max PRSM` = max(PRSM))
kable(installment2_id01_summary, digits = 2, caption = "PRSM after removing outliers")
# Transformations from boxTidwell
boxTidwell_results <- boxTidwell(PRSM ~ TotalAmtOwed +
Volume + Stress + Num_Delinquent +
Num_CreditLines + Months,
data = installment2_id01_clean)
lambda_months <- boxTidwell_results$result[c("Months"),c("MLE of lambda")]
lambda_num_delinquent <- boxTidwell_results$result[c("Num_Delinquent"),c("MLE of lambda")]
transformed_model <- lm(PRSM ~ . - Months + I(Months^(lambda_months)) - Num_Delinquent + I(Num_Delinquent^(lambda_num_delinquent)),
data = installment2_id01_clean)
# summary(transformed_model)$coefficients[,"Pr(>|t|)", drop = FALSE] %>%
#   as.data.frame %>%
#   slice((n() - 1):n()) %>%
#   mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05",
#                              sprintf("%.2f", `Pr(>|t|)`))) %>%
#   kable(digits = 2)
# crPlots(lm(PRSM ~ I(Months^(lambda_months)), data = installment2_id01_clean))
# Step Model
step_model <- step(transformed_model, trace = 0, direction = "both")
# summary(step_model)$coefficients[,c("Estimate","Pr(>|t|)")] %>%
#   as.data.frame %>%
#   slice(2:n()) %>%
#   mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05",
#                              sprintf("%.2f", `Pr(>|t|)`))) %>%
#   kable(digits = 2)
# Find interactions using LASSO
installment2_id01_clean$Months_transformed =
(installment2_id01_clean$Months)^(lambda_months)
x <- model.matrix(PRSM ~ .^2,
data = installment2_id01_clean[,c("PRSM", "FICO",
"TotalAmtOwed","Stress",
"WomanOwned", "CorpStructure",
"Months_transformed", "NAICS")])[, -1]
y <- installment2_id01_clean$PRSM
cv_lasso_interactions <- cv.glmnet(x, y, alpha = 1, nfolds = 10)
best_lambda <- cv_lasso_interactions$lambda.min
lasso_coeffs <- coef(cv_lasso_interactions, s = best_lambda)
threshold <- 0.001
significant_terms <- lasso_coeffs[abs(lasso_coeffs[,1]) > threshold, , drop = FALSE]
# potential interactions: FICO:Stress, FICO:WomanOwned, FICO:CorpStructure, FICO:Months_transformed, Stress:WomanOwned, Stress:CorpStructure, WomanOwned:CorpStructure, WomanOwned:Months_transformed, CorpStructure:Months_transformed, FICO:NAICS, WomanOwned:NAICS, CorpStructure:NAICS, Months_transformed:NAICS, Stress:NAICS
interact_model <- lm(PRSM ~. + FICO:Stress + FICO:WomanOwned + FICO:CorpStructure
+ FICO:Months_transformed + Stress:WomanOwned
+ Stress:CorpStructure + WomanOwned:CorpStructure
+ WomanOwned:Months_transformed + CorpStructure:Months_transformed
+ FICO:NAICS + WomanOwned:NAICS + CorpStructure:NAICS
+ Months_transformed:NAICS + Stress:NAICS
, data = installment2_id01_clean[,c("PRSM", "FICO",
"TotalAmtOwed","Stress",
"WomanOwned", "CorpStructure",
"Months_transformed", "NAICS")])
step_interact_model <- step(interact_model, trace = 0, direction = "both")
step_interact_model
step_interact_model %>%
filter(term !="(Intercept)")
View(step_interact_model)
step_interact_model %>%
filter(terms !="(Intercept)")
library(broom)
plot_df <- tidy(step_interact_model) %>%
filter(terms !="(Intercept)")
tidy(step_interact_model) %>%
filter(terms != "(Intercept)")
tidy(step_interact_model)
tidy(step_interact_model) %>%
filter(term != "(Intercept)")
plot_step_interact_model <- tidy(step_interact_model) %>%
filter(term != "(Intercept)")
tidy(step_interact_model) %>%
filter(term != "(Intercept)")
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col()
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = FALSE)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = FALSE)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = FALSE) +
geom_hline()
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = FALSE) +
geom_hline(yintercept = 0)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = FALSE)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = FALSE) +
geom_hline(yintercept = 0, linewidth = 0.3)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = FALSE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
?geom_text
?geom_text
# printed R summary of the fitted model
summary(step_interact_model)$coefficients[,c("Estimate","Pr(>|t|)")] %>%
as.data.frame %>%
mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05",
sprintf("%.3f", `Pr(>|t|)`))) %>%
kable(digits = 3)
library(stringr)
plot_step_interact_model <- tidy(step_interact_model) %>%
filter(term != "(Intercept)") %>%
mutate(term = str_wrap(term,width = 18))
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = FALSE) +
geom_hline(yintercept = 0, linewidth = 0.3)
plot_step_interact_model <- tidy(step_interact_model) %>%
filter(term != "(Intercept)") %>%
mutate(term = str_wrap(term,width = 10))
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = FALSE) +
geom_hline(yintercept = 0, linewidth = 0.3)
tidy(step_interact_model) %>%
filter(term != "(Intercept)") %>%
mutate(term = str_wrap(term,width = 10))
plot_step_interact_model
plot_step_interact_model
tidy(step_interact_model) %>%
filter(term != "(Intercept)")
plot_step_interact_model <- tidy(step_interact_model) %>%
filter(term != "(Intercept)")
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
labs(x=NULL)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
labs(x=NULL) +
scale_x_discrete(breaks = NULL) +      # remove all category labels
theme(axis.text.x  = element_blank(),  # (belt + suspenders)
axis.ticks.x = element_blank())  # remove tick marks too
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +      # remove all category labels
theme(axis.text.x  = element_blank(),  # (belt + suspenders)
axis.ticks.x = element_blank())  # remove tick marks too
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(axis.text.x  = element_blank())
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(axis.text.x  = element_blank())
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL)
#| label: setup
#| echo: false
#| warning: false
rm(list = ls())
library(dplyr)
library(ModelMetrics)
library(MASS)
library(car)
library(caret)
library(glmnet)
library(ggplot2)
library(knitr)
library(gtsummary)
library(patchwork)
library(broom)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6)
)
plot_step_interact_model <- tidy(step_interact_model) %>%
filter(term != "(Intercept)")
#| label: setup
#| echo: false
#| warning: false
rm(list = ls())
library(dplyr)
library(ModelMetrics)
library(MASS)
library(car)
library(caret)
library(glmnet)
library(ggplot2)
library(knitr)
library(gtsummary)
library(patchwork)
library(broom)
installment2_id01 <- read.csv("installment2_id01.csv")
# make NAICS, WomanOwned, FICO categorical variables
installment2_id01 = installment2_id01 %>%
mutate(NAICS = as.factor(substr(NAICS, 1, 2)),
WomanOwned = as.factor(WomanOwned),
#         Num_Delinquent = as.factor(Num_Delinquent),
#         Num_CreditLines = as.factor(Num_CreditLines),
FICO = case_when(
(300 <= FICO)&(FICO <= 579) ~ "Poor",
(580 <= FICO)&(FICO <= 669) ~ "Fair",
(670 <= FICO)&(FICO <= 739) ~ "Good",
(740 <= FICO)&(FICO <= 799) ~ "Very Good",
(800 <= FICO)&(FICO <= 850) ~ "Excellent",
))
theme_gtsummary_compact()
installment2_id01 %>%
select(FICO, NAICS, WomanOwned) %>%
tbl_summary(
statistic = list(
all_continuous() ~ c(
"{median} ({p25}, {p75})",
"{min}, {max}"
)
),
type = all_continuous() ~ "continuous2"
) %>%
modify_header(all_stat_cols() ~ "**N = {N}**") %>%
modify_footnote(everything() ~ NA_character_)
# TODO: meaningful units?
installment2_id01 %>%
summarise(`min PRSM` = min(PRSM),
`median PRSM` = median(PRSM),
`mean PRSM` = mean(PRSM),
`max PRSM` = max(PRSM)) %>%
kable(digits = 2, caption = "PRSM with outliers")
installment2_id01_clean <- subset(installment2_id01, PRSM > 0 & PRSM < 2)
installment2_id01_summary = installment2_id01_clean %>%
summarise(`min PRSM` = min(PRSM),
`median PRSM` = median(PRSM),
`mean PRSM` = mean(PRSM),
`max PRSM` = max(PRSM))
kable(installment2_id01_summary, digits = 2, caption = "PRSM after removing outliers")
# Transformations from boxTidwell
boxTidwell_results <- boxTidwell(PRSM ~ TotalAmtOwed +
Volume + Stress + Num_Delinquent +
Num_CreditLines + Months,
data = installment2_id01_clean)
lambda_months <- boxTidwell_results$result[c("Months"),c("MLE of lambda")]
lambda_num_delinquent <- boxTidwell_results$result[c("Num_Delinquent"),c("MLE of lambda")]
transformed_model <- lm(PRSM ~ . - Months + I(Months^(lambda_months)) - Num_Delinquent + I(Num_Delinquent^(lambda_num_delinquent)),
data = installment2_id01_clean)
# summary(transformed_model)$coefficients[,"Pr(>|t|)", drop = FALSE] %>%
#   as.data.frame %>%
#   slice((n() - 1):n()) %>%
#   mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05",
#                              sprintf("%.2f", `Pr(>|t|)`))) %>%
#   kable(digits = 2)
# crPlots(lm(PRSM ~ I(Months^(lambda_months)), data = installment2_id01_clean))
# Step Model
step_model <- step(transformed_model, trace = 0, direction = "both")
# summary(step_model)$coefficients[,c("Estimate","Pr(>|t|)")] %>%
#   as.data.frame %>%
#   slice(2:n()) %>%
#   mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05",
#                              sprintf("%.2f", `Pr(>|t|)`))) %>%
#   kable(digits = 2)
# Find interactions using LASSO
installment2_id01_clean$Months_transformed =
(installment2_id01_clean$Months)^(lambda_months)
x <- model.matrix(PRSM ~ .^2,
data = installment2_id01_clean[,c("PRSM", "FICO",
"TotalAmtOwed","Stress",
"WomanOwned", "CorpStructure",
"Months_transformed", "NAICS")])[, -1]
y <- installment2_id01_clean$PRSM
cv_lasso_interactions <- cv.glmnet(x, y, alpha = 1, nfolds = 10)
best_lambda <- cv_lasso_interactions$lambda.min
lasso_coeffs <- coef(cv_lasso_interactions, s = best_lambda)
threshold <- 0.001
significant_terms <- lasso_coeffs[abs(lasso_coeffs[,1]) > threshold, , drop = FALSE]
# potential interactions: FICO:Stress, FICO:WomanOwned, FICO:CorpStructure, FICO:Months_transformed, Stress:WomanOwned, Stress:CorpStructure, WomanOwned:CorpStructure, WomanOwned:Months_transformed, CorpStructure:Months_transformed, FICO:NAICS, WomanOwned:NAICS, CorpStructure:NAICS, Months_transformed:NAICS, Stress:NAICS
interact_model <- lm(PRSM ~. + FICO:Stress + FICO:WomanOwned + FICO:CorpStructure
+ FICO:Months_transformed + Stress:WomanOwned
+ Stress:CorpStructure + WomanOwned:CorpStructure
+ WomanOwned:Months_transformed + CorpStructure:Months_transformed
+ FICO:NAICS + WomanOwned:NAICS + CorpStructure:NAICS
+ Months_transformed:NAICS + Stress:NAICS
, data = installment2_id01_clean[,c("PRSM", "FICO",
"TotalAmtOwed","Stress",
"WomanOwned", "CorpStructure",
"Months_transformed", "NAICS")])
step_interact_model <- step(interact_model, trace = 0, direction = "both")
plot_step_interact_model <- tidy(step_interact_model) %>%
filter(term != "(Intercept)")
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6)
)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6),
legend.key.size = unit(5, "pt")
)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6),
legend.key.size = unit(7, "pt")
)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6),
legend.key.size = unit(12, "pt")
) +
guides(
fill=guide_legend(ncol = 1)
)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6),
legend.key.size = unit(12, "pt")
) +
guides(
fill=guide_legend(ncol = 2)
)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6),
legend.key.size = unit(12, "pt")
) +
guides(
fill=guide_legend(ncol = 3)
)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6),
legend.key.size = unit(12, "pt")
) +
guides(
fill=guide_legend(ncol = 3, byrow = TRUE)
)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6),
legend.key.size = unit(12, "pt")
) +
guides(
fill=guide_legend(ncol = 2, byrow = TRUE)
)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6),
legend.key.size = unit(12, "pt")
)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6),
legend.key.size = unit(12, "pt"),
legend.box.margin = margin(0, 0, 0, 0)
)
?legend.position
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6),
legend.key.size = unit(12, "pt"),
legend.position = "bottom"
)
ggplot(plot_step_interact_model, aes(x = term, y = estimate, fill = term)) +
geom_col(show.legend = TRUE) +
geom_hline(yintercept = 0, linewidth = 0.3) +
scale_x_discrete(breaks = NULL) +
theme(
legend.text = element_text(size = 6),
legend.key.size = unit(12, "pt"),
legend.position = "bottom",
legend.title = element_blank()
)
par(mfrow = c(1, 2))
crPlots(lm(PRSM ~ Months, data = installment2_id01_clean), main = "residual vs. fitted for Months")
crPlots(lm(PRSM ~ I(Months^(lambda_months)), data = installment2_id01_clean), main = "residual vs. fitted for Months transformed")
#| out-width: "50%"
par(mfrow = c(1, 2))
crPlots(lm(PRSM ~ Months, data = installment2_id01_clean), main = "residual vs. fitted for Months")
crPlots(lm(PRSM ~ I(Months^(lambda_months)), data = installment2_id01_clean), main = "residual vs. fitted for Months transformed")
