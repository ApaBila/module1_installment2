---
title: "STAT 628 Credit Risk Project: Installment 2 (technical)"
author: "Bohyoon Lee and Salsabila Mahdi"
date: last-modified
format: pdf
geometry:
  - margin=0.5in
---

```{r}
#| label: setup
#| echo: false
#| warning: false

rm(list = ls())

library(dplyr)
library(ModelMetrics)
library(car)
library(glmnet)
library(ggplot2)
library(knitr)
library(gtsummary)
library(kableExtra)
```

## Data preprocessing and cleaning

### Loading and proper formatting

To start, we load the data then ensure NAICS, WomanOwned, CorpStructure are factors, and discretize FICO.

```{r load_clean, warning=FALSE}
installment2_id01 <- read.csv("installment2_id01.csv")

# Categorical Variable Processing
installment2_id01 <- installment2_id01 %>%
  mutate(NAICS = as.factor(substr(NAICS, 1, 2)),
         WomanOwned = as.factor(WomanOwned),
         CorpStructure = as.factor(CorpStructure),
         FICO = as.factor(case_when(
           (300 <= FICO)&(FICO <= 579) ~ "Poor",
           (580 <= FICO)&(FICO <= 669) ~ "Fair",
           (670 <= FICO)&(FICO <= 739) ~ "Good",
           (740 <= FICO)&(FICO <= 799) ~ "Very Good",
           (800 <= FICO)&(FICO <= 850) ~ "Excellent",
         )))

# Summarize variables
installment2_id01 %>%
  tbl_summary(
    label = list(
      PRSM ~ "PRSM", FICO ~ "FICO Score",
      TotalAmtOwed ~ "Total Amount Owed",
      Volume ~ "Monthly Volume",
      Stress ~ "Stress Ratio",
      Num_Delinquent ~ "Delinquent Credit Lines",
      Num_CreditLines ~ "Total Credit Lines",
      WomanOwned ~ "Woman-Owned", CorpStructure ~ "Corporate Structure", 
      NAICS ~ "Industry (NAICS)", Months ~ "Months in Business"
    ),
    type = list(Num_CreditLines ~ "continuous",Num_Delinquent ~ "continuous"),
    statistic = list(all_continuous() ~ c("{median} ({min} to {max})")
    )
  ) %>% modify_header(all_stat_cols() ~ "**N = {N}**") %>%
  modify_footnote(everything() ~ NA_character_)  %>%
  modify_caption("Summary of Borrower Characteristics") %>% 
  as_kable_extra()

```


### Outlier removal

We then notice a few points have PRSM values that are out of distribution (less than 0 or greater than equal to 2) and remove them. The changes to PRSM are reflected below.

```{r remove_outliers, warning=FALSE}
installment2_id01_clean <- subset(installment2_id01, PRSM > 0 & PRSM <= 2)
installment2_id01_summary <- installment2_id01_clean %>% 
  summarise(`min` = min(PRSM),
            `median` = median(PRSM),
            `mean` = mean(PRSM),
            `max` = max(PRSM))
kable(installment2_id01_summary, digits = 3, 
      caption = paste0("PRSM without outliers (n = ", nrow(installment2_id01_clean), ")"))
```

### Relevel factors

We also relevel the factors for easier interpretation of the baseline borrower
which we'll define as those with the characteristics most commonly realized in the data.
Mode for categorical, median for numerical.

```{r relevel}
get_mode <- function(categorical_x) {mode <- names(which.max(table(categorical_x)))[1]}
installment2_id01_clean$FICO <- relevel(installment2_id01_clean$FICO, 
                                  ref = get_mode(installment2_id01_clean$FICO))
installment2_id01_clean$WomanOwned <- relevel(installment2_id01_clean$WomanOwned,
                                        ref = get_mode(installment2_id01_clean$WomanOwned))
installment2_id01_clean$CorpStructure <- relevel(installment2_id01_clean$CorpStructure,
                                           ref = get_mode(installment2_id01_clean$CorpStructure))
installment2_id01_clean$NAICS <- relevel(installment2_id01_clean$NAICS,
                                           ref = get_mode(installment2_id01_clean$NAICS))
```



## Model Development and Selection

### Linearity and predictor transformation

We look at all Component Residual plots for a model with all the predictor variables.
Below we graph only the predictor of interest for transformation.

```{r transform, warning=FALSE}
crPlots(lm(PRSM ~ Months, data = installment2_id01_clean))

# Transformations from boxTidwell
boxTidwell_results <- boxTidwell(PRSM ~ TotalAmtOwed + Volume + Stress + 
                                   Num_Delinquent + Num_CreditLines + Months,
                                 data = installment2_id01_clean)
lambda_months <- boxTidwell_results$result[c("Months"),c("MLE of lambda")]
lambda_num_delinquent <- boxTidwell_results$result[c("Num_Delinquent"),c("MLE of lambda")]
boxTidwell_results$result[,c("MLE of lambda","Pr(>|t|)" )] %>% 
  as.data.frame %>% 
  mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05", 
                             sprintf("%.2f", `Pr(>|t|)`))) %>%
  kable(digits = 2, caption = "Suggested Power Transformations from Box-Tidwell")
```

Months shows a nonlinear relationship. We invert Months (to be precise, Box-Tidwell suggests `r round(lambda_months, 2)`). 

```{r transform_model, warning=FALSE}
transformed_model <- lm(PRSM ~ . - Months + I(Months^(lambda_months)) -
                          Num_Delinquent + I(Num_Delinquent^(lambda_num_delinquent)),
                       data = installment2_id01_clean)
summary(transformed_model)$coefficients[,c("Estimate","Pr(>|t|)")] %>% 
  as.data.frame %>% 
  mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05", 
                             sprintf("%.2f", `Pr(>|t|)`))) %>%
  kable(digits = 2, caption = "Model with Transformed Variables")
```

The transformed Month predictor is statistically significant but Num_Delinquent is not (see last two rows), even if we remove Num_CreditLines which we find correlates to Num_Delinquent.

### Variable and Interaction Selection

We aim to create a parsimonious model that explains the most variance. We do this in a multi-stage process.

#### First, we use bidirectional stepwise on the model containing all main effects (with Months transformed).

```{r rm_var, warning=FALSE}
# Step Model
step_model <- step(transformed_model, trace = 0, direction = "both")
summary(step_model)$coefficients[,c("Estimate","Pr(>|t|)")] %>% 
  as.data.frame %>% 
  mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05", 
                             sprintf("%.2f", `Pr(>|t|)`))) %>%
  kable(digits = 2, caption = "Model after Bidirectional Stepwise")
```

It identifies Num_Delinquent, and Num_CreditLines as statistically non-significant predictors and removes them. We also remove Volume as it is statistically non-significant and its effect is most likely covered by Stress.

##### Secondly, we search for statistically significant two-way interactions with LASSO, which affect PRSM meaningfully. 

We do LASSO with glmnet (alpha = 1) and 10-fold cross-validation. 
After the optimal shrinkage penalty (lambda) is found, we look at only the coefficients that were not shrunk to 0 by the process.

```{r interaction_lasso, warning=FALSE}
# Find interactions using LASSO
installment2_id01_clean$Months_transformed =
  (installment2_id01_clean$Months)^(lambda_months)
x <- model.matrix(PRSM ~ .^2, # Creates all the two way interactions
                  data = installment2_id01_clean[,c("PRSM", "FICO",
                                                    "TotalAmtOwed","Stress",
                                                    "WomanOwned", "CorpStructure",
                                                    "Months_transformed", "NAICS")])[, -1]
y <- installment2_id01_clean$PRSM
cv_lasso_interactions <- cv.glmnet(x, y, alpha = 1, nfolds = 10)

best_lambda <- cv_lasso_interactions$lambda.min
lasso_coeffs <- coef(cv_lasso_interactions, s = best_lambda)

threshold <- 0.001
significant_terms <- lasso_coeffs[abs(lasso_coeffs[,1]) > threshold, , drop = FALSE]
print(significant_terms)
```

#### Third, we perform bidirectional stepwise regression to select the interaction effects.

We manually add the LASSO interactions between FICO, Stress, WomanOwned and CorpStructure with other predictors to the model. Then we do stepwise as before.

```{r interaction_model, warning=FALSE}
# Potential interactions: FICO:Stress, FICO:WomanOwned,
# FICO:CorpStructure, FICO:Months_transformed, Stress:WomanOwned, 
# Stress:CorpStructure, WomanOwned:CorpStructure, 
# WomanOwned:Months_transformed, CorpStructure:Months_transformed, 
# FICO:NAICS, WomanOwned:NAICS, CorpStructure:NAICS, 
# Months_transformed:NAICS, Stress:NAICS.

interact_model = lm(PRSM ~. + FICO:Stress + FICO:WomanOwned + FICO:CorpStructure 
                    + FICO:Months_transformed + Stress:WomanOwned 
                    + Stress:CorpStructure + WomanOwned:CorpStructure 
                    + WomanOwned:Months_transformed + CorpStructure:Months_transformed
                    + FICO:NAICS + WomanOwned:NAICS + CorpStructure:NAICS 
                    + Months_transformed:NAICS + Stress:NAICS
                      , data = installment2_id01_clean[,c("PRSM", "FICO",
                                                    "TotalAmtOwed","Stress",
                                                    "WomanOwned", "CorpStructure",
                                                    "Months_transformed", "NAICS")])

# printed R summary of the fitted model
step_interact_model = step(interact_model, trace = 0, direction = "both")
summary(step_interact_model)$coefficients[,c("Estimate","Pr(>|t|)")] %>% 
  as.data.frame %>% 
  mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05", 
                             sprintf("%.2f", `Pr(>|t|)`))) %>%
  kable(digits = 2, caption = "Stepwise to Select Interactions, Remove NAICS")

# NAICS is not statistically significant; remove NAICS
interact_model_final = lm(PRSM ~. + FICO:Stress + FICO:WomanOwned + FICO:CorpStructure 
                    + FICO:Months_transformed + Stress:WomanOwned 
                    + Stress:CorpStructure + WomanOwned:CorpStructure 
                    + WomanOwned:Months_transformed + CorpStructure:Months_transformed
                      , data = installment2_id01_clean[,c("PRSM", "FICO",
                                                    "TotalAmtOwed","Stress",
                                                    "WomanOwned", "CorpStructure",
                                                    "Months_transformed")])
step_interact_final = step(interact_model_final, trace = 0, direction = "both")
```


#### Finally, we test the validity of the model. 

```{r final_model_checks, warning=FALSE}
# CHECK ASSUMPTIONS FOR FINAL MODEL
plot(step_interact_final, 2)
plot(step_interact_final, 1)
vif(step_interact_final)[,"GVIF^(1/(2*Df))"] # <5, still ok for multicol

```

Normality and homogenity assumptions hold, and most of the predictors have no or moderate correlations with each other. The model also has the lowest RMSE so we choose it as the final model.

Below is the summary of the fitted model and the RMSE (`r rmse(step_interact_final$fitted.values, installment2_id01_clean$PRSM)`).

```{r summary_fitted, warning=FALSE}
# Printed R summary of the fitted model. This is the final model
summary(step_interact_final)$coefficients[,c("Estimate","Pr(>|t|)")] %>% 
  as.data.frame %>% 
  mutate(`Pr(>|t|)` = ifelse(`Pr(>|t|)` < 0.05, "<0.05", 
                             sprintf("%.3f", `Pr(>|t|)`))) %>%
  kable(digits = 3)

rmse(step_interact_final$fitted.values, installment2_id01_clean$PRSM)
```

### Interpretation

Main effects in the final model:

1.  **FICO Score**. Compared to borrowers with a **Good** FICO score (the baseline), borrowers in other categories perform differently. Borrowers with an **Excellent** score are expected to have a higher PRSM by `r round(summary(step_interact_final)$coefficients[c("FICOExcellent"),c("Estimate")], 3)`, while those with a **Very Good** score see an increase of `r round(summary(step_interact_final)$coefficients[c("FICOVery Good"),c("Estimate")], 3)`. Conversely, those with a **Fair** score have a lower PRSM by `r round(summary(step_interact_final)$coefficients[c("FICOFair"),c("Estimate")], 3)`. The negative effect for the "Poor" category is not statistically significant.

2.  **Total Amount Owed**. Total Amount Owed has no practical effect on PRSM although it is statistically significant with a coefficient of `r round(summary(step_interact_final)$coefficients[c("TotalAmtOwed"),c("Estimate")], 7)`.

3.  **Stress**. Stress has a significantly strong positive effect on PRSM with a coefficient of `r round(summary(step_interact_final)$coefficients[c("Stress"),c("Estimate")], 3)`. For every 0.1 unit increase of Stress, the PRSM increases by `r round(summary(step_interact_final)$coefficients[c("Stress"),c("Estimate")], 3)/10`.

4.  **Woman Owned**. Compared to businesses not owned by women, women-owned businesses are expected to increase PRSM by `r round(summary(step_interact_final)$coefficients[c("WomanOwned1"),c("Estimate")], 3)`.

5.  **Corporate Structure**. Compared to businesses structured as an **LLC** (the baseline), all other structures are associated with a lower PRSM. **Corporations** are associated with a PRSM that is lower by `r round(summary(step_interact_final)$coefficients[c("CorpStructureCorp"),c("Estimate")], 3)`, **Partnerships** by `r round(summary(step_interact_final)$coefficients[c("CorpStructurePartner"),c("Estimate")], 3)`, and **Sole Proprietorships** by `r round(summary(step_interact_final)$coefficients[c("CorpStructureSole"),c("Estimate")], 3)`.

6.  **Months in Business**. The transformed Months variable (Months\^(`r lambda_months`)) gets smaller as the months a business is open increases. Its negative coefficient of `r round(summary(step_interact_final)$coefficients[c("Months_transformed"),c("Estimate")], 3)` indicates that PRSM increases as the business ages, though this effect diminishes over time.

Interaction effects in the final model:

1.  **FICO:WomanOwned**. The positive main effect of a business being woman-owned is modified by the borrower's FICO score. For a woman-owned business with an **Excellent** FICO score, the PRSM increases by an *additional* `r round(summary(step_interact_final)$coefficients[c("FICOExcellent:WomanOwned1"),c("Estimate")], 3)`. Conversely, the effect is reduced for those with **Fair** and **Poor** scores, with an additional change of `r round(summary(step_interact_final)$coefficients[c("FICOFair:WomanOwned1"),c("Estimate")], 3)` and `r round(summary(step_interact_final)$coefficients[c("FICOPoor:WomanOwned1"),c("Estimate")], 3)`, respectively. The interaction for the "Very Good" category is not statistically significant.

2.  **FICO:Months_transformed**. The effect of business age on PRSM is significantly different for borrowers in the **Excellent** and **Very Good** FICO categories compared to the "Good" baseline. The effect of `Months_transformed` changes by an additional `r round(summary(step_interact_final)$coefficients[c("FICOExcellent:Months_transformed"),c("Estimate")], 3)` for "Excellent" borrowers and by `r round(summary(step_interact_final)$coefficients[c("FICOVery Good:Months_transformed"),c("Estimate")], 3)` for "Very Good" borrowers. Other FICO interaction terms for this variable are not statistically significant.

3.  **Stress:WomanOwned**. The positive effect of Stress on PRSM is even stronger for woman-owned businesses. For every 0.1 unit increase in Stress, the PRSM for a woman-owned business increases by an *additional* `r round(summary(step_interact_final)$coefficients[c("Stress:WomanOwned1"),c("Estimate")]*0.1, 3)` compared to a non-woman-owned business.

4.  **WomanOwned:CorpStructure**. For woman-owned businesses, the negative main effects associated with non-LLC structures are lessened. The PRSM for a **woman-owned Corporation** increases by an additional `r round(summary(step_interact_final)$coefficients[c("WomanOwned1:CorpStructureCorp"),c("Estimate")], 3)`, a **woman-owned Partnership** by `r round(summary(step_interact_final)$coefficients[c("WomanOwned1:CorpStructurePartner"),c("Estimate")], 3)`, and a **woman-owned Sole Proprietorship** by `r round(summary(step_interact_final)$coefficients[c("WomanOwned1:CorpStructureSole"),c("Estimate")], 3)`.

5.  **CorpStructure:Months_transformed**. The effect of business age on PRSM is significantly different for corporations compared to LLCs. For a **Corporation**, the effect of `Months_transformed` changes by an additional `r round(summary(step_interact_final)$coefficients[c("CorpStructureCorp:Months_transformed"),c("Estimate")], 3)`. The effects for other structures are not statistically significant.

### Baseline Borrower

Below is the baseline borrower status.

```{r baseline, warning=FALSE}
newdata<-installment2_id01_clean[1, 2:ncol(installment2_id01_clean)]
newdata[,c("FICO")] <- get_mode(installment2_id01_clean$FICO)
newdata[,c("TotalAmtOwed")] <- median(installment2_id01_clean$TotalAmtOwed)
newdata[,c("Stress")] <- median(installment2_id01_clean$Stress)
newdata[,c("WomanOwned")] <- get_mode(installment2_id01_clean$WomanOwned)
newdata[,c("CorpStructure")] <- get_mode(installment2_id01_clean$CorpStructure)
newdata[,c("Months")] <- median(installment2_id01_clean$Months)
newdata[,c("Months_transformed")] <- median(installment2_id01_clean$Months)^lambda_months
kable(t(newdata), col.names = c("Predictors","Status"))
```

The baseline borrower has a Good FICO score, `r median(installment2_id01_clean$TotalAmtOwed)` of Total Amount Owed, and `r median(installment2_id01_clean$Stress)` of Stress, is not a woman, is structured as a LLC, and has opened the business for `r median(installment2_id01_clean$Months)` months. The predicted PRSM for the baseline borrower would be `r round(predict(step_interact_final, 
        newdata=newdata), 8)`

### Evaluation Prediction

``` {r prediction_evaluation, warning=FALSE, eval=FALSE}
evaluation_data <- read.csv(file = "installment2_evaluation_data.csv") 
evaluation_data <- evaluation_data %>% 
  mutate(Months_transformed = Months^lambda_months,
         NAICS = as.factor(substr(NAICS, 1, 2)),
         WomanOwned = as.factor(WomanOwned),
         CorpStructure = as.factor(CorpStructure),
         FICO = as.factor(case_when(
           (300 <= FICO)&(FICO <= 579) ~ "Poor",
           (580 <= FICO)&(FICO <= 669) ~ "Fair",
           (670 <= FICO)&(FICO <= 739) ~ "Good",
           (740 <= FICO)&(FICO <= 799) ~ "Very Good",
           (800 <= FICO)&(FICO <= 850) ~ "Excellent",
         )))

predictions <- predict(
 object = step_interact_final,
 newdata = evaluation_data,
 interval = "prediction"
 )
write.csv(predictions, file = "predictions.csv")
```